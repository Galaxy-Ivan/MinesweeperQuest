<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>Minesweeper Quest</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 20px; }
        input, button, select, textarea { font-size: 14px; padding: 6px; }
        table {
            width: 90%;
            border-collapse: collapse;
            margin-top: 12px;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        th { background: #f5f5f5; }
        th:nth-child(1), td:nth-child(1) { width: 15%; }
        th:nth-child(2), td:nth-child(2) { width: 15%; }
        th:nth-child(3), td:nth-child(3) { width: 10%; }
        th:nth-child(4), td:nth-child(4) { width: 50%; }
        th:nth-child(5), td:nth-child(5) { width: 10%; }
        .small { font-size: 13px; color: #666; }
        .controls { display:flex; gap:8px; align-items:center; margin-bottom: 8px; }
        .right { margin-left: auto; }
        .pagination { margin-top: 12px; display: flex; justify-content: flex-end; gap: 4px; }
        .pagination select { padding: 4px; }
    </style>
</head>
<body>
<h2>Minesweeper Quest</h2>

<div class="controls">
    <label>用户名（唯一身份标识）： <input id="username" placeholder="WoM" /></label>
    <button id="saveName">保存</button>

    <div class="right">
        <label>等级 <input id="newLevel" placeholder="L??" /></label>
        <label>详情 <input id="newDetails" placeholder="任务描述" /></label>
        <button id="addTask">发布任务</button>
    </div>
</div>

<table>
    <thead>
    <tr>
        <th>发布者</th>
        <th>领取者</th>
        <th>等级</th>
        <th>详细信息</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody id="taskBody">
    <!-- rows rendered here -->
    </tbody>
</table>

<div class="pagination">
    <label>页数：
        <select id="pageSelect"></select>
    </label>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;
    let currentTasks = []; // 保存最新任务
    let currentPage = 1;
    const pageSize = 10;

    function setStatus(msg) { console.log(msg); }

    function loadNameToInput() {
        const stored = localStorage.getItem('mq_username') || '';
        document.getElementById('username').value = stored;
    }

    function saveName() {
        const name = document.getElementById('username').value.trim();
        if (name.includes('"')) { alert('姓名不能包含双引号 "'); return; }
        if (!name) { alert('请输入一个名字'); return; }
        localStorage.setItem('mq_username', name);
        alert('保存成功：' + name);
    }

    document.getElementById('saveName').addEventListener('click', saveName);
    loadNameToInput();

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            setStatus('connected: ' + frame);
            stompClient.subscribe('/topic/tasks', function(message) {
                try {
                    currentTasks = JSON.parse(message.body);
                    renderTasks(currentTasks, currentPage);
                    renderPagination(currentTasks.length);
                } catch (e) {
                    console.error('解析 tasks 失败', e, message.body);
                }
            });
        }, function(err) {
            console.error('STOMP 连接错误', err);
        });
    }

    function fetchTasks() {
        fetch('/api/tasks').then(r => r.json()).then(tasks => {
            currentTasks = tasks;
            renderTasks(currentTasks, currentPage);
            renderPagination(currentTasks.length);
        }).catch(e => console.error(e));
    }

    function renderTasks(tasks, page) {
        const tbody = document.getElementById('taskBody');
        tbody.innerHTML = '';
        const myName = (localStorage.getItem('mq_username') || '').trim();

        // 分页处理
        const startIdx = (page - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        const pageTasks = tasks.slice(startIdx, endIdx);

        pageTasks.forEach(t => {
            const tr = document.createElement('tr');
            const pubTd = document.createElement('td'); pubTd.textContent = t.publisher; tr.appendChild(pubTd);
            const assTd = document.createElement('td'); assTd.textContent = t.assignee && t.assignee.length ? t.assignee : '-'; tr.appendChild(assTd);
            const levelTd = document.createElement('td'); levelTd.textContent = t.level; tr.appendChild(levelTd);
            const detTd = document.createElement('td'); detTd.textContent = t.details; tr.appendChild(detTd);

            const btnTd = document.createElement('td');

            if (myName && myName === t.publisher) {
                const btn = document.createElement('button');
                btn.textContent = '删除';
                btn.dataset.confirm = 'false';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    if (btn.dataset.confirm === 'false') {
                        btn.textContent = '确定删除';
                        btn.dataset.confirm = 'true';
                    } else {
                        fetch(`/api/tasks/${encodeURIComponent(t.id)}/delete`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user: myName })
                        }).then(resp => {
                            if (!resp.ok) resp.text().then(txt => alert('删除失败: ' + txt));
                        });
                    }
                };
                btnTd.appendChild(btn);
            } else {
                if (!t.assignee || t.assignee.length === 0) {
                    const btn = document.createElement('button');
                    btn.textContent = '领取任务';
                    btn.onclick = () => {
                        const name = localStorage.getItem('mq_username') || '';
                        if (!name) { alert('请先在上方填写并保存你的名字'); return; }
                        if (name.includes('"')) { alert('姓名不能包含双引号 "'); return; }
                        fetch(`/api/tasks/${encodeURIComponent(t.id)}/claim`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user: name })
                        }).then(resp => {
                            if (!resp.ok) resp.text().then(txt => alert('领取失败: ' + txt));
                        });
                    };
                    btnTd.appendChild(btn);
                } else if (t.assignee === myName) {
                    const btn = document.createElement('button');
                    btn.textContent = '放弃任务';
                    btn.onclick = () => {
                        const name = localStorage.getItem('mq_username') || '';
                        fetch(`/api/tasks/${encodeURIComponent(t.id)}/unclaim`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user: name })
                        }).then(resp => {
                            if (!resp.ok) resp.text().then(txt => alert('放弃失败: ' + txt));
                        });
                    };
                    btnTd.appendChild(btn);
                } else {
                    const span = document.createElement('span');
                    span.textContent = '已被领取';
                    btnTd.appendChild(span);
                }
            }

            tr.appendChild(btnTd);
            tbody.prepend(tr);
        });

        // 恢复所有删除按钮状态
        document.addEventListener('click', () => {
            document.querySelectorAll('button[data-confirm="true"]').forEach(btn => {
                btn.textContent = '删除';
                btn.dataset.confirm = 'false';
            });
        });
    }

    // 渲染分页下拉框
    function renderPagination(totalTasks) {
        const pageSelect = document.getElementById('pageSelect');
        const totalPages = Math.ceil(totalTasks / pageSize);
        pageSelect.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = i;
            if (i === currentPage) opt.selected = true;
            pageSelect.appendChild(opt);
        }
    }

    // 处理分页选择
    document.getElementById('pageSelect').addEventListener('change', (e) => {
        currentPage = parseInt(e.target.value);
        renderTasks(currentTasks, currentPage);
    });

    // 发布新任务
    document.getElementById('addTask').addEventListener('click', () => {
        const publisher = (localStorage.getItem('mq_username') || '').trim();
        if (!publisher) { alert('请先填写并保存你的名字'); return; }
        if (publisher.includes('"')) { alert('姓名不能包含双引号 "'); return; }
        const level = document.getElementById('newLevel').value;
        const details = document.getElementById('newDetails').value || '';
        fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ publisher, level, details })
        }).then(resp => {
            if (!resp.ok) resp.text().then(txt => alert('发布失败: ' + txt));
            else document.getElementById('newDetails').value = '';
        }).catch(e => console.error(e));
    });

    // 启动
    connect();
    fetchTasks();
</script>
</body>
</html>
